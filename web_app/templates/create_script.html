{% extends "base.html" %}

{% block title %}Create New Script - WinPick{% endblock %}

{% block css %}
<style>
    .script-editor {
        font-family: 'Cascadia Code', 'Consolas', monospace;
        font-size: 0.9rem;
        min-height: 400px;
        background-color: #1e1e1e;
        color: #d4d4d4;
        resize: vertical;
        padding: 15px;
        border-radius: 5px;
        line-height: 1.5;
    }
    
    .editor-container {
        position: relative;
    }
    
    .script-type-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.75rem;
        padding: 2px 8px;
    }
    
    .form-hint {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 4px;
    }
    
    /* Custom checkbox styling */
    .custom-checkbox {
        position: relative;
        padding-left: 30px;
        cursor: pointer;
        user-select: none;
    }
    
    .custom-checkbox input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    
    .checkmark {
        position: absolute;
        top: 0;
        left: 0;
        height: 20px;
        width: 20px;
        background-color: #eee;
        border-radius: 3px;
    }
    
    .custom-checkbox:hover input ~ .checkmark {
        background-color: #ccc;
    }
    
    .custom-checkbox input:checked ~ .checkmark {
        background-color: #3F51B5;
    }
    
    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }
    
    .custom-checkbox input:checked ~ .checkmark:after {
        display: block;
    }
    
    .custom-checkbox .checkmark:after {
        left: 7px;
        top: 3px;
        width: 6px;
        height: 12px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Back Button -->
    <div class="col-12 mb-3">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i> Back to Scripts
        </a>
    </div>
    
    <!-- Page Title -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-plus me-2"></i> Create New Script</h4>
            </div>
        </div>
    </div>
    
    <!-- Script Form -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <form id="create-script-form" method="post" action="{{ url_for('create_script') }}">
                    <div class="row">
                        <!-- Left Column - Script Info -->
                        <div class="col-md-5 mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle me-2"></i> Script Information
                            </h5>
                            
                            <!-- Script Name -->
                            <div class="mb-3">
                                <label for="script-name" class="form-label">Script Name*</label>
                                <input type="text" class="form-control" id="script-name" name="name" required>
                                <div class="form-hint">A descriptive name for your script</div>
                            </div>
                            
                            <!-- Category -->
                            <div class="mb-3">
                                <label for="script-category" class="form-label">Category*</label>
                                <select class="form-select" id="script-category" name="category" required>
                                    {% for category in categories %}
                                    <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>
                                        {{ category }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-hint">The category this script belongs to</div>
                            </div>
                            
                            <!-- Script Type -->
                            <div class="mb-3">
                                <label for="script-type" class="form-label">Script Type*</label>
                                <select class="form-select" id="script-type" name="type" required>
                                    <option value=".py">Python Script (.py)</option>
                                    <option value=".ps1">PowerShell Script (.ps1)</option>
                                    <option value=".bat">Batch Script (.bat)</option>
                                    <option value=".cmd">Command Script (.cmd)</option>
                                </select>
                                <div class="form-hint">The type of script to create</div>
                            </div>
                            
                            <!-- Developer -->
                            <div class="mb-3">
                                <label for="script-developer" class="form-label">Developer</label>
                                <input type="text" class="form-control" id="script-developer" name="developer" value="MikeTheTech">
                                <div class="form-hint">Your name or identifier</div>
                            </div>
                            
                            <!-- Developer Link -->
                            <div class="mb-3">
                                <label for="script-link" class="form-label">Developer Link</label>
                                <input type="url" class="form-control" id="script-link" name="link" value="https://github.com/itsmikethetech">
                                <div class="form-hint">Optional link to your profile or website</div>
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-3">
                                <label for="script-description" class="form-label">Description</label>
                                <textarea class="form-control" id="script-description" name="description" rows="3"></textarea>
                                <div class="form-hint">Describe what this script does</div>
                            </div>
                            
                            <!-- Undoable Checkbox -->
                            <div class="mb-3">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="script-undoable" name="undoable" value="true">
                                    <span class="checkmark"></span>
                                    Script is undoable
                                </label>
                                <div class="form-hint ms-4">Check if the script supports undo functionality</div>
                            </div>
                            
                            <!-- Undo Description -->
                            <div class="mb-3">
                                <label for="script-undo-desc" class="form-label">Undo Description</label>
                                <input type="text" class="form-control" id="script-undo-desc" name="undo_desc" value="Reverts the changes made by this script">
                                <div class="form-hint">Describe what happens when the script is undone</div>
                            </div>
                        </div>
                        
                        <!-- Right Column - Script Content -->
                        <div class="col-md-7">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-code me-2"></i> Script Content
                            </h5>
                            
                            <div class="mb-3 editor-container">
                                <span id="script-type-badge" class="badge bg-primary script-type-badge">
                                    <i class="fab fa-python me-1"></i> Python
                                </span>
                                <textarea class="form-control script-editor" id="script-content" name="content" rows="20"></textarea>
                            </div>
                            
                            <div class="mb-3 d-flex justify-content-end">
                                <button type="button" class="btn btn-outline-secondary me-2" id="reset-btn">
                                    <i class="fas fa-undo me-1"></i> Reset to Template
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Create Script
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize variables
        const scriptTypeSelect = document.getElementById('script-type');
        const scriptContentTextarea = document.getElementById('script-content');
        const scriptTypeBadge = document.getElementById('script-type-badge');
        const scriptUndoable = document.getElementById('script-undoable');
        const scriptUndoDesc = document.getElementById('script-undo-desc');
        const scriptName = document.getElementById('script-name');
        const scriptDeveloper = document.getElementById('script-developer');
        const scriptLink = document.getElementById('script-link');
        const scriptDescription = document.getElementById('script-description');
        const resetBtn = document.getElementById('reset-btn');
        
        // Initial state
        updateTemplate();
        scriptUndoable.addEventListener('change', updateTemplate);
        scriptTypeSelect.addEventListener('change', updateBadgeAndTemplate);
        scriptName.addEventListener('input', updateTemplate);
        scriptDeveloper.addEventListener('input', updateTemplate);
        scriptLink.addEventListener('input', updateTemplate);
        scriptDescription.addEventListener('input', updateTemplate);
        scriptUndoDesc.addEventListener('input', updateTemplate);
        resetBtn.addEventListener('click', updateTemplate);
        
        // Update badge and template when script type changes
        function updateBadgeAndTemplate() {
            const scriptType = scriptTypeSelect.value;
            
            // Update badge styling
            if (scriptType === '.py') {
                scriptTypeBadge.className = 'badge bg-success script-type-badge';
                scriptTypeBadge.innerHTML = '<i class="fab fa-python me-1"></i> Python';
            } else if (scriptType === '.ps1') {
                scriptTypeBadge.className = 'badge bg-primary script-type-badge';
                scriptTypeBadge.innerHTML = '<i class="fas fa-terminal me-1"></i> PowerShell';
            } else if (scriptType === '.bat') {
                scriptTypeBadge.className = 'badge bg-secondary script-type-badge';
                scriptTypeBadge.innerHTML = '<i class="fas fa-terminal me-1"></i> Batch';
            } else if (scriptType === '.cmd') {
                scriptTypeBadge.className = 'badge bg-secondary script-type-badge';
                scriptTypeBadge.innerHTML = '<i class="fas fa-terminal me-1"></i> Command';
            }
            
            updateTemplate();
        }
        
        // Update the script content template based on inputs
        function updateTemplate() {
            const name = scriptName.value || 'Script Name';
            const developer = scriptDeveloper.value || 'MikeTheTech';
            const link = scriptLink.value || 'https://github.com/itsmikethetech';
            const description = scriptDescription.value || 'Script Description';
            const undoable = scriptUndoable.checked ? 'Yes' : 'No';
            const undoDesc = scriptUndoDesc.value || 'Reverts the changes made by this script';
            const scriptType = scriptTypeSelect.value;
            
            // Disable undo description field if undoable is unchecked
            if (scriptUndoable.checked) {
                scriptUndoDesc.disabled = false;
            } else {
                scriptUndoDesc.disabled = true;
            }
            
            let template = '';
            
            // Create template based on script type
            if (scriptType === '.py') {
                template = `# NAME: ${name}
# DEVELOPER: ${developer}
# LINK: ${link}
# DESCRIPTION: ${description}
# UNDOABLE: ${undoable}
# UNDO_DESC: ${undoDesc}
#
# This is a Python script template with undo capability

import os
import sys
import argparse

def main():
    parser = argparse.ArgumentParser(description='${description}')
    parser.add_argument('--undo', action='store_true', help='Undo the changes made by this script')
    args = parser.parse_args()
    
    if args.undo:
        perform_undo()
    else:
        perform_action()

def perform_action():
    print("Performing main action...")
    # Your main code here
    
def perform_undo():
    print("Performing undo action...")
    # Your undo code here

if __name__ == "__main__":
    main()`;
            } else if (scriptType === '.ps1') {
                template = `# NAME: ${name}
# DEVELOPER: ${developer}
# LINK: ${link}
# DESCRIPTION: ${description}
# UNDOABLE: ${undoable}
# UNDO_DESC: ${undoDesc}
#
# This is a PowerShell script template with undo capability

param (
    [switch]$Undo
)

function Perform-Action {
    Write-Host "Performing main action..."
    # Your main code here
}

function Perform-Undo {
    Write-Host "Performing undo action..."
    # Your undo code here
}

if ($Undo) {
    Perform-Undo
} else {
    Perform-Action
}`;
            } else if (scriptType === '.bat' || scriptType === '.cmd') {
                template = `:: NAME: ${name}
:: DEVELOPER: ${developer}
:: LINK: ${link}
:: DESCRIPTION: ${description}
:: UNDOABLE: ${undoable}
:: UNDO_DESC: ${undoDesc}
::
:: This is a Batch script template with undo capability

@echo off

if "%1"=="undo" goto :undo

:main
echo Performing main action...
:: Your main code here
goto :end

:undo
echo Performing undo action...
:: Your undo code here
goto :end

:end
pause`;
            }
            
            scriptContentTextarea.value = template;
        }
    });
</script>
{% endblock %}