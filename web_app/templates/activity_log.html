{% extends "base.html" %}

{% block title %}Activity Log - WinPick{% endblock %}

{% block css %}
<style>
    .console-output {
        height: 80vh;
        overflow-y: auto;
        font-family: 'Cascadia Code', 'Consolas', monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 15px;
        border-radius: 5px;
    }
    
    .console-line {
        margin: 0;
        padding: 2px 0;
    }
    
    .console-error {
        color: #f14c4c;
    }
    
    .console-warning {
        color: #e6cd3d;
    }
    
    .console-success {
        color: #4cd964;
    }
    
    .console-info {
        color: #5ac8fa;
    }
    
    .timestamp {
        color: #888;
        margin-right: 8px;
    }
    
    /* Custom scrollbar for console */
    .console-output::-webkit-scrollbar {
        width: 8px;
    }
    
    .console-output::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
    }
    
    .console-output::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
    }
    
    .console-output::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .action-bar {
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Back Button -->
    <div class="col-12 mb-3">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i> Back to Scripts
        </a>
    </div>
    
    <!-- Page Title -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-history me-2"></i> Activity Log</h4>
            </div>
        </div>
    </div>
    
    <!-- Log View -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="action-bar d-flex justify-content-between align-items-center">
                    <div>
                        <strong>System Activity Log:</strong>
                        <span class="text-muted ms-2">Showing recent activity and script executions</span>
                    </div>
                    <div>
                        <button id="refresh-log-btn" class="btn btn-outline-primary btn-sm me-2">
                            <i class="fas fa-sync-alt me-1"></i> Refresh
                        </button>
                        <button id="clear-log-btn" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-trash-alt me-1"></i> Clear Log
                        </button>
                    </div>
                </div>
                
                <div id="console-output" class="console-output">
                    {% if console_output %}
                        {% for line in console_output %}
                            <div class="console-line {% if 'ERROR' in line %}console-error{% elif 'WARNING' in line %}console-warning{% elif 'SUCCESS' in line %}console-success{% elif 'INFO' in line %}console-info{% endif %}">{{ line }}</div>
                        {% endfor %}
                    {% else %}
                        <div class="console-line">No activity has been logged yet.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const consoleOutput = document.getElementById('console-output');
        const refreshBtn = document.getElementById('refresh-log-btn');
        const clearBtn = document.getElementById('clear-log-btn');
        
        // Function to update console output
        function updateConsoleOutput() {
            fetch('/console_output')
            .then(response => response.json())
            .then(data => {
                consoleOutput.innerHTML = '';
                
                if (data.output.length === 0) {
                    consoleOutput.innerHTML = '<div class="console-line">No activity has been logged yet.</div>';
                    return;
                }
                
                data.output.forEach(line => {
                    const lineClass = 
                        line.includes('ERROR') ? 'console-error' : 
                        line.includes('WARNING') ? 'console-warning' : 
                        line.includes('SUCCESS') ? 'console-success' : 
                        line.includes('INFO') ? 'console-info' : '';
                    
                    consoleOutput.innerHTML += `<div class="console-line ${lineClass}">${line}</div>`;
                });
                
                // Scroll to bottom
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            })
            .catch(error => console.error('Error:', error));
        }
        
        // Refresh button
        refreshBtn.addEventListener('click', updateConsoleOutput);
        
        // Clear log button
        clearBtn.addEventListener('click', function() {
            fetch('/clear_console', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    consoleOutput.innerHTML = '<div class="console-line">Console cleared.</div>';
                }
            })
            .catch(error => console.error('Error:', error));
        });
        
        // Initial load
        updateConsoleOutput();
        
        // Auto-refresh every 10 seconds
        setInterval(updateConsoleOutput, 10000);
    });
</script>
{% endblock %}